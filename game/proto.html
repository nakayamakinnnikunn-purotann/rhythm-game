<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="utf-8">
            <title>シンプル音ゲー</title>
            <style media="screen">
                #world{
                    position: relative;
                    z-index: 1;
                }
            </style>
    </head>
    <body>
        <canvas id="app"></canvas>
        <canvas id="filter"></canvas>
        <div id="time"></div>
        <button id="pause">pause</button>
        <button id="resetBtn">reset</button>
        <input type="number" id="seek" value="">
        <script>

// var game = (function(){
//     var _p = 10;
//     return {
//         update: function(){
//             return alert(_p);
//         },
//         get p(){
//             return _p;
//         },
//         set p(v){
//             if(v<100) {
//                 _p = v;
//             }else{
//                 throw new Error('invalid number!');
//             }
//         }
//     }
// })();
// game.p = 107; //ee
// console.log(game.p);

var raw = ["0_2_4_8", "0_2_2_8", "4_8_12_14", "5_8_12_14"];
var bpm = 120;
// var _zerohour = 0.58; //秒
var _zerohour = 0; //秒
// var beat = (1 / (bpm/60)); //4分ノーツの時間

function noteListMaker(rawList, bpm, zero){
    var raw = rawList;
    var list = [];
    var u = (1 / (bpm/60)) * 0.25; //16分ノーツの時間
    console.log(u);
    for (var i = 0; i < raw.length; i++) {
        var bar = String(raw[i]);
        //console.log(bar);
        var _arr = bar.split('_');
        for (var j = 0; j < _arr.length; j++) {
            // console.log(_arr[j]);
            var n = (Number(_arr[j]) + 16*i) * u + zero;
            list.push(n);
        }
    }
    // console.log(list);
    return list;
}
            //shorthand
            var $id = function(id) { return document.getElementById(id); }
            Array.prototype.randomPick = function(){
                var i = Math.floor(Math.random()*this.length);
                return this[i];
            }
            //定数
            var SCREEN_WIDTH = window.innerwidth / 3;
            var SCREEN_HEIGHT = SCREEN_WIDTH * 0.75;
            // var NOTE_LIST = noteListMaker(raw, bpm, _zerohour);
            var NOTE_LIST = null;
            // var BPM = 147;
            var SOUND_ASSETS = {
                // bgm: "./assets/two_tor_real.mp3",
                bgm: "./assets/Game_gadget_at_midnight.mp3",
                clap:"./assets/clap.mp3",
                conga: "./assets/conga.mp3"
            };
            // 判定範囲
            var RATING = {
                out: 0.13,
                good: 0.10,
                cool: 0.05,
                great: 0.03
            };

            // 判定スコア
            var SCORE = {
                good: 20,
                cool: 50,
                great: 100,
                hold: 10
            }

            // HTML要素取得
            var app = document.getElementById('app');
            var filter = document.getElementById('filter');
            var timer = document.getElementById('time');
            var pauseBtn = document.getElementById('pause');
            pauseBtn.addEventListener('click', function(){
                music.pause();
            });
            $id('seek').onblur = function(){
                console.log(this.value);
                noteList = NOTE_LIST.slice();
                music.currentTime = this.value;
            }

            // app.width = SCREEN_WIDTH;
            // app.height = SCREEN_HEIGHT;
            // 情報格納用変数とか
            var noteList = []; //譜面情報
            var hitEffect = null;
            var score = 0;
            var chainNum = 0;
            var rateText = null;
            var longNote = null; // ロングノート情報
            var btnFlg = false; // ボタンが押下状態フラグ
            // var isPlaying = false; // プレイ中
            var autoPlay = false;
            var speed = 1.0;

            // 譜面位置・判定調整用
            var calib = 0; // 判定調整用　good判定より小さいこと
            var zerohour = 0; // 譜面開始秒数（音楽再生位置）

            // 音源ロード
            var sounds = {} // サウンド管理;
            var music, se1, se2;
            //forEachで回して登録
            var _keys = Object.keys(SOUND_ASSETS);
            _keys.forEach(function(key){
                var audio = new Audio(SOUND_ASSETS[key]);
                console.log(audio);
                // canplaythroughイベントはplay()時にも発生するため、ロードがおわったらイベントリスナをremove
                // http://webkatu.com/remove-eventlistener/
                audio.addEventListener('canplaythrough', (function(x){
                    return function load(){
                        sounds[x] = audio; //登録
                        console.log(Object.keys(sounds).length+" "+Object.keys(SOUND_ASSETS).length);
                        audio.removeEventListener('canplaythrough', load);
                        if (Object.keys(sounds).length === _keys.length) {
                            console.log("gerta");
                            init();
                        }
                    }
                })(key));

                audio.onerror = function(e){
                    throw new Error(e.target.error);
                }

            }, this);

            // var music = new Audio("./assets/dualmoon.mp3");
            // //ロード確認
            // music.addEventListener('canplaythrough', function(){
            //     console.log(music.readyState); //4だったらOK
            //     init();
            // });
            //
            // var se1 = new Audio("./assets/clap.mp3");
            // var se2 = new Audio("./assets/conga.mp3");
            // se2.src = "./asset/conga.mp3";

            function init() {
                // 譜面情報の取得
                httpObj = new XMLHttpRequest();
                // httpObj.open("get", "./data/midnight-fumen_sorted.json", true);
                httpObj.open("get", "./data/midnight-fumen_rev1.json", true);
                httpObj.onload = function(){
                    // console.log(this.res);
                    importData(this.responseText);

                    music = sounds.bgm;
                    se1 =  sounds.clap;
                    se2 =  sounds.conga;
                    noteList = NOTE_LIST.slice();

                    if (autoPlay) btnFlg = true;
                    console.log(btnFlg);
                    music.play();
                    main();
                }
                httpObj.onerror = function(e){
                    console.log(e);
                }
                httpObj.send(null);

            }

            // loop
            function main() {
                timer.innerHTML = music.currentTime;
                screenRender();

                //long note 処理
                if (longNote != null) {
                    var rTime = longNote - music.currentTime + calib;
                    // ボタンを押している
                    if (btnFlg) {
                        // 終了時間に達していない
                        if (rTime > RATING.great) {
                            hitEffect = 3;
                            effect('hold');
                        // 規定時間まで押しつづけたら終了
                        }else{
                            console.log(longNote);
                            longNote = null;
                            effect('great');
                        }
                    // 途中で離してしまった
                    // 離したタイミングによって判定を変える場合、ここをいじる
                    }else{
                        longNote = null;
                        miss();
                    }
                }

                setTimeout(main, 1000/60); // ループ
            }

            // 計算用：より早く計算させる？
            // function calc(){
            //      if (!isPlaying) return;
            //     noteList.forEach(function(noteTime){
            //         // 無入力判定：判定ラインを超え、かつ判定時間を過ぎたらmissそして消す　分離した方がいい？
            //         // ロングノート判定中は引っかからないようにする
            //         if (music.currentTime > noteTime + RATING.good && !longNote){
            //             noteList.shift();
            //             miss();
            //         }
            //
            //     });
            //
            //     //long note 処理
            //     if (longNote != null) {
            //         var rTime = longNote+zerohour - music.currentTime + calib;
            //
            //         // ボタンを押している
            //         if (btnFlg) {
            //             // 終了時間に達していない
            //             if (rTime > 0) {
            //                 // console.log('ji');
            //                 hitEffect = 3;
            //                 effect('hold');
            //             // 規定時間まで押しつづけたら終了
            //             }else{
            //                 longNote = null;
            //                 effect('great');
            //             }
            //         // 途中で離してしまった
            //         }else{
            //             longNote = null;
            //             miss();
            //         }
            //     }
            //
            // }

            // 画面描画用パラメータ（定数（ゲーム中に変更することの無い変数）は慣例として大文字）
            var NOTE_WIDTH = 28; // ノーツの幅：画面サイズで変える？
            var NOTE_HEIGHT = 6; //
            // var NOTE_POS_MARGIN_LEFT =
            var NOTE_POSES =[NOTE_WIDTH*2, NOTE_WIDTH*3, NOTE_WIDTH*4, NOTE_WIDTH*5];
            var notePosBase = SCREEN_WIDTH / NOTE_WIDTH;
            var NOTE_COLOR = "rgb(106, 235, 244)";
            var LONG_NOTE_COLOR = "rgb(77, 60, 212)";
            var JUDGE_LINE_START_X = 10;
            var JUDGE_LINE_END_X = app.width - JUDGE_LINE_START_X;
            var JUDGE_LINE_Y = app.height * 0.8; //
            var NOTE_DEST_Y = JUDGE_LINE_Y - NOTE_HEIGHT * 0.5; //最終位置Y
            var RATING_TEXT_POS_X = app.width * 0.5,
                  RATING_TEXT_POS_Y = app.height * 0.4;
            var SCORE_TEXT_POS_X =  app.width * 0.9,
                  SCORE_TEXT_POS_Y = 16;
            var WATER_COLOR = "rgba(15, 131, 187, 0.81)";

            function screenRender() {
                var ctx = app.getContext('2d');
                var relativeTime = 0; // 再生位置とノーツ出現情報との差、０のとき判定ライン位置になるように
                var corr = 160 * speed; // 補正、ハイスピ
                var deltaY; // 判定ラインまでの距離
                var drawingPointX = 120; // X軸 描画位置
                var drawingPointY; // Y軸 描画位置

                //画面初期化：背景色で塗りつぶす
                ctx.fillStyle = "rgba(0, 0, 0, 0.5)"; // ブラーエフェクト
                // ctx.fillStyle = "rgba(0, 0, 0, 1)";
                ctx.fillRect(0, 0, app.width, app.height);

                //ノーツの描画
                noteList.forEach(function(noteTime, i){
                    // if (i%4 == 0) {
                    //     corr =  40;
                    // }else{
                    //     corr = 140;
                    // }
                    // drawingPointX = NOTE_POSES.randomPick();
                    var noteHeight = NOTE_HEIGHT;

                    // ロングノートだったら
                    if (typeof noteTime == 'object') {
                        ctx.fillStyle = LONG_NOTE_COLOR;
                        var _lastTime = noteTime[1];
                        // 最終位置に合わせて、ノーツ高さを変更する
                        noteHeight = - (_lastTime - noteTime[0]) * corr; //上方向に伸ばすため、マイナス値
                        noteTime = noteTime[0];
                    }else{
                        ctx.fillStyle = NOTE_COLOR;
                    }
                    noteTime += zerohour;
                    // 描画位置を決める
                    relativeTime = noteTime - music.currentTime;
                    deltaY = relativeTime * corr;
                    drawingPointY = NOTE_DEST_Y - deltaY;

                    // 画面外だったら描画をスキップして次のループへ
                    if (drawingPointY < 0) return;

                    // 判定ライン位置でストップ & ロングノートの場合高さを縮める
                    if (relativeTime < 0){
                        noteHeight -= relativeTime * corr;
                        drawingPointY = NOTE_DEST_Y;
                    }

                    // ノーツ描く
                    ctx.fillRect(drawingPointX, drawingPointY, NOTE_WIDTH, noteHeight);

                    // 無入力判定：判定ラインを超え、かつ判定時間を過ぎたらmissそして消す　分離した方がいい？
                    // ロングノート判定中に引っかからないようにする（ロングノート情報を消してしまうため）
                    if (music.currentTime > noteTime + RATING.good && !longNote){
                        // noteList.shift();
                        noteList.splice(i, 1);
                        miss();
                    }

                    //オートプレイ
                    //great範囲内に入ったら即座に反応
                    // ロングノート判定中にロングノート情報を消さないようにする
                    if (autoPlay && !longNote) {
                        if (music.currentTime > noteTime - RATING.great){
                            // noteList.shift();
                            judge();
                        }
                    }
                });

                // 判定ラインの描画
                ctx.globalAlpha = 1; //opacity
                ctx.fillStyle = "blue";
                ctx.fillRect(JUDGE_LINE_START_X, JUDGE_LINE_Y, JUDGE_LINE_END_X, 200);
                ctx.strokeStyle = "white";
                ctx.moveTo(JUDGE_LINE_START_X, JUDGE_LINE_Y);
                ctx.lineTo(JUDGE_LINE_END_X, JUDGE_LINE_Y);
                ctx.stroke(); // ライン引く

                // スコア表示とか
                // フォント設定
                ctx.fillStyle = "white"; // 色は白
                ctx.font = "bold 14px 'Verdana, sans-serif'"; // フォントのウエイト、サイズ、ファミリー
                ctx.textAlign = 'center'; // 軸を文字列中央に持ってくる

                // "great!"とか
                if (rateText){
                    ctx.fillText(rateText, RATING_TEXT_POS_X,  RATING_TEXT_POS_Y);
                    // rateText = null;
                }

                // チェイン数
                if (chainNum !== 0){
                    ctx.fillText(chainNum+" CHAIN", RATING_TEXT_POS_X,  RATING_TEXT_POS_Y + 16);
                }

                //スコア
                ctx.textAlign = 'right'; //軸を文字列中央に持ってくる
                ctx.fillText("SCORE "+score, SCORE_TEXT_POS_X,  SCORE_TEXT_POS_Y);

                //エフェクトの描画
                // effect変数には整数が入り、０以上のときに描画
                if (hitEffect>0) {
                    ctx.save();
                    // ctx.globalAlpha = hitEffect * 0.2; //opacity
                    drawGradRect(ctx, drawingPointX, JUDGE_LINE_Y-120,  NOTE_WIDTH, 120, WATER_COLOR);
                    hitEffect--;
                    ctx.restore();
                    // setTimeout(function(){console.log(effectTime);hitEffect = null;},100);
                }

                function drawGradRect(context, x, y,  width, height, color){
                    var _width = width;
                    var _height = height;
                    // var _color =  'hsla('+ colorHue +', 50%, 50%, 0.7)';
                    var _color =  color;
                    context.beginPath();

                    // グラデーション領域をセット
                    var grad  = context.createLinearGradient(0, 0, 0, _height);

                    // グラデーション終点のオフセットと色をセット
                    grad.addColorStop(0, 'rgba(0, 0, 0, 0)');  // 透明
                    grad.addColorStop(1, _color);

                    // グラデーションをfillStyleプロパティにセット
                    context.fillStyle = grad;

                    // 矩形を描画
                    context.fillRect(x, y, _width, _height);
                }

            }

            //　判定処理
            function judge() {
                // 最も判定ラインに近いノーツ（配列の先頭にあるノーツ）を見る
                var noteTime = noteList[0];
                var _longEnd = null; //ロング最終位置を一時保持

                //ロングノートだったら
                if (typeof noteTime == 'object') {
                    _longEnd = noteTime[1];
                    noteTime = noteTime[0]; //ノーツを
                    _longEnd += zerohour;
                    // console.log(noteTime);
                }
                noteTime += zerohour;

                // 正判定位置からどれくらいずれているか
                var rTime = noteTime - music.currentTime + calib; // 再生位置と先頭ノーツ出現時間との差
                // console.log(longNote);
                // 早押し・遅押しを区別しない場合
                if (rTime < 0) rTime *= -1;

                // 判定範囲外なら何もせず終了
                if (rTime > RATING.out) return;

                longNote = _longEnd;

                if (rTime < RATING.great) return effect("great");

                if (rTime < RATING.cool) return effect("cool");

                if (rTime < RATING.good) return effect("good");

                longNote = null;

                if (rTime < RATING.out) return effect("miss");

                // 判定受付範囲外の場合は無し
                // 下のように書いても同じ

                // if (){
                // } else if (rTime) {
                //
                // }

            }

            // 判定時の反応 reactionでもいいかも
            function effect(rating){
                if (longNote == null) noteList.shift(); //ロングでなければ現在ノート消す
                // noteList.shift(); //ロングでなければ現在ノート消す

                switch (rating) {
                    case "great":
                        chainNum++;
                        rateText = "GREAT!!!";
                        playShot(se1);
                        // se1.play();
                        hitEffect = 16;
                        score += SCORE.great;
                        console.log("great!!!");

                        break;

                    case "cool":
                        chainNum++;
                        rateText = "COOL!";
                        hitEffect = 10;
                        playShot(se1);
                        score += SCORE.cool;
                        console.log("cool!");
                        // noteList.shift();
                        break;

                    case "good":
                        chainNum++;
                        rateText = "GOOD";
                        playShot(se2);
                        score += SCORE.good;
                        console.log("good");
                        // noteList.shift();
                        break;

                    case "hold":
                        // rateText = "HOLD!";
                        // chainNum++;
                        // playShot(se2);
                        score += SCORE.hold;
                        break;

                    case "miss":
                        miss();
                        playShot(se2);
                        // noteList.shift();
                        break;

                    default:
                        break;
                }
            }

            // 使いまわせるように切り出す
            function miss(){
                chainNum = 0; // チェイン切る
                rateText = "MISS...";
                console.log("miss...");
            }

            // ショット音再生
            function playShot(audio){
                if(!audio.ended){
                    //巻き戻し再生
                    audio.pause();
                    audio.currentTime = 0;  // 再生位置を0秒にする
                    audio.play();
                }else{
                    audio.play();
                }
            }

            // 入力系
            // mousedownとkeydown(スペースバー)で
            if (!autoPlay) {
                app.addEventListener('mousedown', function(e){
                    e.preventDefault();
                    btnFlg = true;
                    judge();
                });
                document.addEventListener('keydown', function(e){
                    // if (e.keyCode == 32) return judge();
                    if(btnFlg) return;
                    btnFlg = true;
                    if(longNote) return;
                    judge();
                    // console.log(e);
                });
                app.addEventListener('mouseup', function(e){
                    btnFlg = false;
                });
                document.addEventListener('keyup', function(e){
                    btnFlg = false;
                });
            }

            function importData(data){
                var dataobj;
                try {
                    dataobj = JSON.parse(data); //オブジェクト化
                } catch(e) {
                    alert(e+'\n正しいjsonデータでは無いっぽいです…');
                }
                // 各数値代入
                bpm = dataobj.BPM;
                NOTE_LIST =  dataobj.noteList;
                zerohour = dataobj.zerohour;
            }

//==============================
            $id('resetBtn').addEventListener('click', resetGame, false);
            function resetGame(){
                music.currentTime = 0;
                rateText = null;
                chainNum = 0;
                noteList = NOTE_LIST.slice();
                music.play();
            }

            function audioLoader(key){
                var audio = new Audio(SOUND_ASSETS[key]);
                audio.addEventListener('canplaythrough', function(){
                    sounds[key] = audio;
                    console.log(Object.keys(sounds).length+" "+Object.keys(SOUND_ASSETS).length);
                    // sounds.push(audio);
                    audio.removeEventListener('canplaythrough', audioLoader);
                    if (Object.keys(sounds).length == Object.keys(SOUND_ASSETS).length) {
                        console.log(sounds[key]);
                        //loadEnd
                        init();
                    }
                });
                audio.onerror = function(e){
                    console.warn(e);
                }
            }

        </script>
    </body>
</html>
