!function(){"use strict";var e=function(){this.init()};e.prototype={init:function(){var e=this||n;return e._codecs={},e._howls=[],e._muted=!1,e._volume=1,e._canPlayEvent="canplaythrough",e._navigator="undefined"!=typeof window&&window.navigator?window.navigator:null,e.masterGain=null,e.noAudio=!1,e.usingWebAudio=!0,e.autoSuspend=!0,e.ctx=null,e.mobileAutoEnable=!0,e._setup(),e},volume:function(e){var o=this||n;if(e=parseFloat(e),o.ctx||_(),"undefined"!=typeof e&&e>=0&&e<=1){if(o._volume=e,o._muted)return o;o.usingWebAudio&&(o.masterGain.gain.value=e);for(var t=0;t<o._howls.length;t++)if(!o._howls[t]._webAudio)for(var r=o._howls[t]._getSoundIds(),a=0;a<r.length;a++){var u=o._howls[t]._soundById(r[a]);u&&u._node&&(u._node.volume=u._volume*e)}return o}return o._volume},mute:function(e){var o=this||n;o.ctx||_(),o._muted=e,o.usingWebAudio&&(o.masterGain.gain.value=e?0:o._volume);for(var t=0;t<o._howls.length;t++)if(!o._howls[t]._webAudio)for(var r=o._howls[t]._getSoundIds(),a=0;a<r.length;a++){var u=o._howls[t]._soundById(r[a]);u&&u._node&&(u._node.muted=!!e||u._muted)}return o},unload:function(){for(var e=this||n,o=e._howls.length-1;o>=0;o--)e._howls[o].unload();return e.usingWebAudio&&"undefined"!=typeof e.ctx.close&&(e.ctx.close(),e.ctx=null,_()),e},codecs:function(e){return(this||n)._codecs[e.replace(/^x-/,"")]},_setup:function(){var e=this||n;return e.state=e.ctx?e.ctx.state||"running":"running",e._autoSuspend(),e.noAudio||e._setupCodecs(),e},_setupCodecs:function(){var e=this||n,o="undefined"!=typeof Audio?new Audio:null;if(!o||"function"!=typeof o.canPlayType)return e;var t=o.canPlayType("audio/mpeg;").replace(/^no$/,""),r=e._navigator&&e._navigator.userAgent.match(/OPR\/([0-6].)/g),a=r&&parseInt(r[0].split("/")[1],10)<33;return e._codecs={mp3:!(a||!t&&!o.canPlayType("audio/mp3;").replace(/^no$/,"")),mpeg:!!t,opus:!!o.canPlayType('audio/ogg; codecs="opus"').replace(/^no$/,""),ogg:!!o.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),oga:!!o.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),wav:!!o.canPlayType('audio/wav; codecs="1"').replace(/^no$/,""),aac:!!o.canPlayType("audio/aac;").replace(/^no$/,""),caf:!!o.canPlayType("audio/x-caf;").replace(/^no$/,""),m4a:!!(o.canPlayType("audio/x-m4a;")||o.canPlayType("audio/m4a;")||o.canPlayType("audio/aac;")).replace(/^no$/,""),mp4:!!(o.canPlayType("audio/x-mp4;")||o.canPlayType("audio/mp4;")||o.canPlayType("audio/aac;")).replace(/^no$/,""),weba:!!o.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,""),webm:!!o.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,""),dolby:!!o.canPlayType('audio/mp4; codecs="ec-3"').replace(/^no$/,""),flac:!!(o.canPlayType("audio/x-flac;")||o.canPlayType("audio/flac;")).replace(/^no$/,"")},e},_enableMobileAudio:function(){var e=this||n,o=/iPhone|iPad|iPod|Android|BlackBerry|BB10|Silk|Mobi/i.test(e._navigator&&e._navigator.userAgent),t=!!("ontouchend"in window||e._navigator&&e._navigator.maxTouchPoints>0||e._navigator&&e._navigator.msMaxTouchPoints>0);if(!e._mobileEnabled&&e.ctx&&(o||t)){e._mobileEnabled=!1,e._mobileUnloaded||44100===e.ctx.sampleRate||(e._mobileUnloaded=!0,e.unload()),e._scratchBuffer=e.ctx.createBuffer(1,1,22050);var r=function(){var n=e.ctx.createBufferSource();n.buffer=e._scratchBuffer,n.connect(e.ctx.destination),"undefined"==typeof n.start?n.noteOn(0):n.start(0),n.onended=function(){n.disconnect(0),e._mobileEnabled=!0,e.mobileAutoEnable=!1,document.removeEventListener("touchend",r,!0)}};return document.addEventListener("touchend",r,!0),e}},_autoSuspend:function(){var e=this;if(e.autoSuspend&&e.ctx&&"undefined"!=typeof e.ctx.suspend&&n.usingWebAudio){for(var o=0;o<e._howls.length;o++)if(e._howls[o]._webAudio)for(var t=0;t<e._howls[o]._sounds.length;t++)if(!e._howls[o]._sounds[t]._paused)return e;return e._suspendTimer&&clearTimeout(e._suspendTimer),e._suspendTimer=setTimeout(function(){e.autoSuspend&&(e._suspendTimer=null,e.state="suspending",e.ctx.suspend().then(function(){e.state="suspended",e._resumeAfterSuspend&&(delete e._resumeAfterSuspend,e._autoResume())}))},3e4),e}},_autoResume:function(){var e=this;if(e.ctx&&"undefined"!=typeof e.ctx.resume&&n.usingWebAudio)return"running"===e.state&&e._suspendTimer?(clearTimeout(e._suspendTimer),e._suspendTimer=null):"suspended"===e.state?(e.state="resuming",e.ctx.resume().then(function(){e.state="running"}),e._suspendTimer&&(clearTimeout(e._suspendTimer),e._suspendTimer=null)):"suspending"===e.state&&(e._resumeAfterSuspend=!0),e}};var n=new e,o=function(e){var n=this;return e.src&&0!==e.src.length?void n.init(e):void console.error("An array of source files must be passed with any new Howl.")};o.prototype={init:function(e){var o=this;return n.ctx||_(),o._autoplay=e.autoplay||!1,o._format="string"!=typeof e.format?e.format:[e.format],o._html5=e.html5||!1,o._muted=e.mute||!1,o._loop=e.loop||!1,o._pool=e.pool||5,o._preload="boolean"!=typeof e.preload||e.preload,o._rate=e.rate||1,o._sprite=e.sprite||{},o._src="string"!=typeof e.src?e.src:[e.src],o._volume=void 0!==e.volume?e.volume:1,o._duration=0,o._state="unloaded",o._sounds=[],o._endTimers={},o._queue=[],o._onend=e.onend?[{fn:e.onend}]:[],o._onfade=e.onfade?[{fn:e.onfade}]:[],o._onload=e.onload?[{fn:e.onload}]:[],o._onloaderror=e.onloaderror?[{fn:e.onloaderror}]:[],o._onpause=e.onpause?[{fn:e.onpause}]:[],o._onplay=e.onplay?[{fn:e.onplay}]:[],o._onstop=e.onstop?[{fn:e.onstop}]:[],o._onmute=e.onmute?[{fn:e.onmute}]:[],o._onvolume=e.onvolume?[{fn:e.onvolume}]:[],o._onrate=e.onrate?[{fn:e.onrate}]:[],o._onseek=e.onseek?[{fn:e.onseek}]:[],o._webAudio=n.usingWebAudio&&!o._html5,"undefined"!=typeof n.ctx&&n.ctx&&n.mobileAutoEnable&&n._enableMobileAudio(),n._howls.push(o),o._preload&&o.load(),o},load:function(){var e=this,o=null;if(n.noAudio)return void e._emit("loaderror",null,"No audio support.");"string"==typeof e._src&&(e._src=[e._src]);for(var r=0;r<e._src.length;r++){var u,d;if(e._format&&e._format[r])u=e._format[r];else{if(d=e._src[r],"string"!=typeof d){e._emit("loaderror",null,"Non-string found in selected audio sources - ignoring.");continue}u=/^data:audio\/([^;,]+);/i.exec(d),u||(u=/\.([^.]+)$/.exec(d.split("?",1)[0])),u&&(u=u[1].toLowerCase())}if(n.codecs(u)){o=e._src[r];break}}return o?(e._src=o,e._state="loading","https:"===window.location.protocol&&"http:"===o.slice(0,5)&&(e._html5=!0,e._webAudio=!1),new t(e),e._webAudio&&a(e),e):void e._emit("loaderror",null,"No codec support for selected audio sources.")},play:function(e,o){var t=this,r=null;if("number"==typeof e)r=e,e=null;else{if("string"==typeof e&&"loaded"===t._state&&!t._sprite[e])return null;if("undefined"==typeof e){e="__default";for(var a=0,u=0;u<t._sounds.length;u++)t._sounds[u]._paused&&!t._sounds[u]._ended&&(a++,r=t._sounds[u]._id);1===a?e=null:r=null}}var d=r?t._soundById(r):t._inactiveSound();if(!d)return null;if(r&&!e&&(e=d._sprite||"__default"),"loaded"!==t._state&&!t._sprite[e])return t._queue.push({event:"play",action:function(){t.play(t._soundById(d._id)?d._id:void 0)}}),d._id;if(r&&!d._paused)return o||setTimeout(function(){t._emit("play",d._id)},0),d._id;t._webAudio&&n._autoResume();var i=d._seek>0?d._seek:t._sprite[e][0]/1e3,_=(t._sprite[e][0]+t._sprite[e][1])/1e3-i,s=1e3*_/Math.abs(d._rate);d._paused=!1,d._ended=!1,d._sprite=e,d._seek=i,d._start=t._sprite[e][0]/1e3,d._stop=(t._sprite[e][0]+t._sprite[e][1])/1e3,d._loop=!(!d._loop&&!t._sprite[e][2]);var l=d._node;if(t._webAudio){var f=function(){t._refreshBuffer(d);var e=d._muted||t._muted?0:d._volume;l.gain.setValueAtTime(e,n.ctx.currentTime),d._playStart=n.ctx.currentTime,"undefined"==typeof l.bufferSource.start?d._loop?l.bufferSource.noteGrainOn(0,i,86400):l.bufferSource.noteGrainOn(0,i,_):d._loop?l.bufferSource.start(0,i,86400):l.bufferSource.start(0,i,_),s!==1/0&&(t._endTimers[d._id]=setTimeout(t._ended.bind(t,d),s)),o||setTimeout(function(){t._emit("play",d._id)},0)};"loaded"===t._state?f():(t.once("load",f,d._id),t._clearTimer(d._id))}else{var c=function(){l.currentTime=i,l.muted=d._muted||t._muted||n._muted||l.muted,l.volume=d._volume*n.volume(),l.playbackRate=d._rate,setTimeout(function(){l.play(),s!==1/0&&(t._endTimers[d._id]=setTimeout(t._ended.bind(t,d),s)),o||t._emit("play",d._id)},0)},p="loaded"===t._state&&(window&&window.ejecta||!l.readyState&&n._navigator.isCocoonJS);if(4===l.readyState||p)c();else{var m=function(){c(),l.removeEventListener(n._canPlayEvent,m,!1)};l.addEventListener(n._canPlayEvent,m,!1),t._clearTimer(d._id)}}return d._id},pause:function(e){var n=this;if("loaded"!==n._state)return n._queue.push({event:"pause",action:function(){n.pause(e)}}),n;for(var o=n._getSoundIds(e),t=0;t<o.length;t++){n._clearTimer(o[t]);var r=n._soundById(o[t]);if(r&&!r._paused){if(r._seek=n.seek(o[t]),r._rateSeek=0,r._paused=!0,n._stopFade(o[t]),r._node)if(n._webAudio){if(!r._node.bufferSource)return n;"undefined"==typeof r._node.bufferSource.stop?r._node.bufferSource.noteOff(0):r._node.bufferSource.stop(0),n._cleanBuffer(r._node)}else isNaN(r._node.duration)&&r._node.duration!==1/0||r._node.pause();arguments[1]||n._emit("pause",r._id)}}return n},stop:function(e,n){var o=this;if("loaded"!==o._state)return o._queue.push({event:"stop",action:function(){o.stop(e)}}),o;for(var t=o._getSoundIds(e),r=0;r<t.length;r++){o._clearTimer(t[r]);var a=o._soundById(t[r]);if(a&&(a._seek=a._start||0,a._rateSeek=0,a._paused=!0,a._ended=!0,o._stopFade(t[r]),a._node))if(o._webAudio){if(!a._node.bufferSource)return n||o._emit("stop",a._id),o;"undefined"==typeof a._node.bufferSource.stop?a._node.bufferSource.noteOff(0):a._node.bufferSource.stop(0),o._cleanBuffer(a._node)}else isNaN(a._node.duration)&&a._node.duration!==1/0||(a._node.currentTime=a._start||0,a._node.pause());a&&!n&&o._emit("stop",a._id)}return o},mute:function(e,o){var t=this;if("loaded"!==t._state)return t._queue.push({event:"mute",action:function(){t.mute(e,o)}}),t;if("undefined"==typeof o){if("boolean"!=typeof e)return t._muted;t._muted=e}for(var r=t._getSoundIds(o),a=0;a<r.length;a++){var u=t._soundById(r[a]);u&&(u._muted=e,t._webAudio&&u._node?u._node.gain.setValueAtTime(e?0:u._volume,n.ctx.currentTime):u._node&&(u._node.muted=!!n._muted||e),t._emit("mute",u._id))}return t},volume:function(){var e,o,t=this,r=arguments;if(0===r.length)return t._volume;if(1===r.length||2===r.length&&"undefined"==typeof r[1]){var a=t._getSoundIds(),u=a.indexOf(r[0]);u>=0?o=parseInt(r[0],10):e=parseFloat(r[0])}else r.length>=2&&(e=parseFloat(r[0]),o=parseInt(r[1],10));var d;if(!("undefined"!=typeof e&&e>=0&&e<=1))return d=o?t._soundById(o):t._sounds[0],d?d._volume:0;if("loaded"!==t._state)return t._queue.push({event:"volume",action:function(){t.volume.apply(t,r)}}),t;"undefined"==typeof o&&(t._volume=e),o=t._getSoundIds(o);for(var i=0;i<o.length;i++)d=t._soundById(o[i]),d&&(d._volume=e,r[2]||t._stopFade(o[i]),t._webAudio&&d._node&&!d._muted?d._node.gain.setValueAtTime(e,n.ctx.currentTime):d._node&&!d._muted&&(d._node.volume=e*n.volume()),t._emit("volume",d._id));return t},fade:function(e,o,t,r){var a=this,u=Math.abs(e-o),d=e>o?"out":"in",i=u/.01,_=i>0?t/i:t;if(_<4&&(i=Math.ceil(i/(4/_)),_=4),"loaded"!==a._state)return a._queue.push({event:"fade",action:function(){a.fade(e,o,t,r)}}),a;a.volume(e,r);for(var s=a._getSoundIds(r),l=0;l<s.length;l++){var f=a._soundById(s[l]);if(f){if(r||a._stopFade(s[l]),a._webAudio&&!f._muted){var c=n.ctx.currentTime,p=c+t/1e3;f._volume=e,f._node.gain.setValueAtTime(e,c),f._node.gain.linearRampToValueAtTime(o,p)}var m=e;f._interval=setInterval(function(e,n){i>0&&(m+="in"===d?.01:-.01),m=Math.max(0,m),m=Math.min(1,m),m=Math.round(100*m)/100,a._webAudio?("undefined"==typeof r&&(a._volume=m),n._volume=m):a.volume(m,e,!0),m===o&&(clearInterval(n._interval),n._interval=null,a.volume(m,e),a._emit("fade",e))}.bind(a,s[l],f),_)}}return a},_stopFade:function(e){var o=this,t=o._soundById(e);return t&&t._interval&&(o._webAudio&&t._node.gain.cancelScheduledValues(n.ctx.currentTime),clearInterval(t._interval),t._interval=null,o._emit("fade",e)),o},loop:function(){var e,n,o,t=this,r=arguments;if(0===r.length)return t._loop;if(1===r.length){if("boolean"!=typeof r[0])return o=t._soundById(parseInt(r[0],10)),!!o&&o._loop;e=r[0],t._loop=e}else 2===r.length&&(e=r[0],n=parseInt(r[1],10));for(var a=t._getSoundIds(n),u=0;u<a.length;u++)o=t._soundById(a[u]),o&&(o._loop=e,t._webAudio&&o._node&&o._node.bufferSource&&(o._node.bufferSource.loop=e,e&&(o._node.bufferSource.loopStart=o._start||0,o._node.bufferSource.loopEnd=o._stop)));return t},rate:function(){var e,o,t=this,r=arguments;if(0===r.length)o=t._sounds[0]._id;else if(1===r.length){var a=t._getSoundIds(),u=a.indexOf(r[0]);u>=0?o=parseInt(r[0],10):e=parseFloat(r[0])}else 2===r.length&&(e=parseFloat(r[0]),o=parseInt(r[1],10));var d;if("number"!=typeof e)return d=t._soundById(o),d?d._rate:t._rate;if("loaded"!==t._state)return t._queue.push({event:"rate",action:function(){t.rate.apply(t,r)}}),t;"undefined"==typeof o&&(t._rate=e),o=t._getSoundIds(o);for(var i=0;i<o.length;i++)if(d=t._soundById(o[i])){d._rateSeek=t.seek(o[i]),d._playStart=t._webAudio?n.ctx.currentTime:d._playStart,d._rate=e,t._webAudio&&d._node&&d._node.bufferSource?d._node.bufferSource.playbackRate.value=e:d._node&&(d._node.playbackRate=e);var _=t.seek(o[i]),s=(t._sprite[d._sprite][0]+t._sprite[d._sprite][1])/1e3-_,l=1e3*s/Math.abs(d._rate);!t._endTimers[o[i]]&&d._paused||(t._clearTimer(o[i]),t._endTimers[o[i]]=setTimeout(t._ended.bind(t,d),l)),t._emit("rate",d._id)}return t},seek:function(){var e,o,t=this,r=arguments;if(0===r.length)o=t._sounds[0]._id;else if(1===r.length){var a=t._getSoundIds(),u=a.indexOf(r[0]);u>=0?o=parseInt(r[0],10):(o=t._sounds[0]._id,e=parseFloat(r[0]))}else 2===r.length&&(e=parseFloat(r[0]),o=parseInt(r[1],10));if("undefined"==typeof o)return t;if("loaded"!==t._state)return t._queue.push({event:"seek",action:function(){t.seek.apply(t,r)}}),t;var d=t._soundById(o);if(d){if(!("number"==typeof e&&e>=0)){if(t._webAudio){var i=t.playing(o)?n.ctx.currentTime-d._playStart:0,_=d._rateSeek?d._rateSeek-d._seek:0;return d._seek+(_+i*Math.abs(d._rate))}return d._node.currentTime}var s=t.playing(o);s&&t.pause(o,!0),d._seek=e,d._ended=!1,t._clearTimer(o),s&&t.play(o,!0),!t._webAudio&&d._node&&(d._node.currentTime=e),t._emit("seek",o)}return t},playing:function(e){var n=this;if("number"==typeof e){var o=n._soundById(e);return!!o&&!o._paused}for(var t=0;t<n._sounds.length;t++)if(!n._sounds[t]._paused)return!0;return!1},duration:function(e){var n=this,o=n._duration,t=n._soundById(e);return t&&(o=n._sprite[t._sprite][1]/1e3),o},state:function(){return this._state},unload:function(){for(var e=this,o=e._sounds,t=0;t<o.length;t++){o[t]._paused||(e.stop(o[t]._id),e._emit("end",o[t]._id)),e._webAudio||(o[t]._node.src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQAAAAA=",o[t]._node.removeEventListener("error",o[t]._errorFn,!1),o[t]._node.removeEventListener(n._canPlayEvent,o[t]._loadFn,!1)),delete o[t]._node,e._clearTimer(o[t]._id);var a=n._howls.indexOf(e);a>=0&&n._howls.splice(a,1)}var u=!0;for(t=0;t<n._howls.length;t++)if(n._howls[t]._src===e._src){u=!1;break}return r&&u&&delete r[e._src],n.noAudio=!1,e._state="unloaded",e._sounds=[],e=null,null},on:function(e,n,o,t){var r=this,a=r["_on"+e];return"function"==typeof n&&a.push(t?{id:o,fn:n,once:t}:{id:o,fn:n}),r},off:function(e,n,o){var t=this,r=t["_on"+e],a=0;if(n){for(a=0;a<r.length;a++)if(n===r[a].fn&&o===r[a].id){r.splice(a,1);break}}else if(e)t["_on"+e]=[];else{var u=Object.keys(t);for(a=0;a<u.length;a++)0===u[a].indexOf("_on")&&Array.isArray(t[u[a]])&&(t[u[a]]=[])}return t},once:function(e,n,o){var t=this;return t.on(e,n,o,1),t},_emit:function(e,n,o){for(var t=this,r=t["_on"+e],a=r.length-1;a>=0;a--)r[a].id&&r[a].id!==n&&"load"!==e||(setTimeout(function(e){e.call(this,n,o)}.bind(t,r[a].fn),0),r[a].once&&t.off(e,r[a].fn,r[a].id));return t},_loadQueue:function(){var e=this;if(e._queue.length>0){var n=e._queue[0];e.once(n.event,function(){e._queue.shift(),e._loadQueue()}),n.action()}return e},_ended:function(e){var o=this,t=e._sprite,r=!(!e._loop&&!o._sprite[t][2]);if(o._emit("end",e._id),!o._webAudio&&r&&o.stop(e._id,!0).play(e._id),o._webAudio&&r){o._emit("play",e._id),e._seek=e._start||0,e._rateSeek=0,e._playStart=n.ctx.currentTime;var a=1e3*(e._stop-e._start)/Math.abs(e._rate);o._endTimers[e._id]=setTimeout(o._ended.bind(o,e),a)}return o._webAudio&&!r&&(e._paused=!0,e._ended=!0,e._seek=e._start||0,e._rateSeek=0,o._clearTimer(e._id),o._cleanBuffer(e._node),n._autoSuspend()),o._webAudio||r||o.stop(e._id),o},_clearTimer:function(e){var n=this;return n._endTimers[e]&&(clearTimeout(n._endTimers[e]),delete n._endTimers[e]),n},_soundById:function(e){for(var n=this,o=0;o<n._sounds.length;o++)if(e===n._sounds[o]._id)return n._sounds[o];return null},_inactiveSound:function(){var e=this;e._drain();for(var n=0;n<e._sounds.length;n++)if(e._sounds[n]._ended)return e._sounds[n].reset();return new t(e)},_drain:function(){var e=this,n=e._pool,o=0,t=0;if(!(e._sounds.length<n)){for(t=0;t<e._sounds.length;t++)e._sounds[t]._ended&&o++;for(t=e._sounds.length-1;t>=0;t--){if(o<=n)return;e._sounds[t]._ended&&(e._webAudio&&e._sounds[t]._node&&e._sounds[t]._node.disconnect(0),e._sounds.splice(t,1),o--)}}},_getSoundIds:function(e){var n=this;if("undefined"==typeof e){for(var o=[],t=0;t<n._sounds.length;t++)o.push(n._sounds[t]._id);return o}return[e]},_refreshBuffer:function(e){var o=this;return e._node.bufferSource=n.ctx.createBufferSource(),e._node.bufferSource.buffer=r[o._src],e._panner?e._node.bufferSource.connect(e._panner):e._node.bufferSource.connect(e._node),e._node.bufferSource.loop=e._loop,e._loop&&(e._node.bufferSource.loopStart=e._start||0,e._node.bufferSource.loopEnd=e._stop),e._node.bufferSource.playbackRate.value=e._rate,o},_cleanBuffer:function(e){var n=this;if(n._scratchBuffer){e.bufferSource.onended=null,e.bufferSource.disconnect(0);try{e.bufferSource.buffer=n._scratchBuffer}catch(e){}}return e.bufferSource=null,n}};var t=function(e){this._parent=e,this.init()};t.prototype={init:function(){var e=this,n=e._parent;return e._muted=n._muted,e._loop=n._loop,e._volume=n._volume,e._muted=n._muted,e._rate=n._rate,e._seek=0,e._paused=!0,e._ended=!0,e._sprite="__default",e._id=Math.round(Date.now()*Math.random()),n._sounds.push(e),e.create(),e},create:function(){var e=this,o=e._parent,t=n._muted||e._muted||e._parent._muted?0:e._volume;return o._webAudio?(e._node="undefined"==typeof n.ctx.createGain?n.ctx.createGainNode():n.ctx.createGain(),e._node.gain.setValueAtTime(t,n.ctx.currentTime),e._node.paused=!0,e._node.connect(n.masterGain)):(e._node=new Audio,e._errorFn=e._errorListener.bind(e),e._node.addEventListener("error",e._errorFn,!1),e._loadFn=e._loadListener.bind(e),e._node.addEventListener(n._canPlayEvent,e._loadFn,!1),e._node.src=o._src,e._node.preload="auto",e._node.volume=t*n.volume(),e._node.load()),e},reset:function(){var e=this,n=e._parent;return e._muted=n._muted,e._loop=n._loop,e._volume=n._volume,e._muted=n._muted,e._rate=n._rate,e._seek=0,e._rateSeek=0,e._paused=!0,e._ended=!0,e._sprite="__default",e._id=Math.round(Date.now()*Math.random()),e},_errorListener:function(){var e=this;e._parent._emit("loaderror",e._id,e._node.error?e._node.error.code:0),e._node.removeEventListener("error",e._errorListener,!1)},_loadListener:function(){var e=this,o=e._parent;o._duration=Math.ceil(10*e._node.duration)/10,0===Object.keys(o._sprite).length&&(o._sprite={__default:[0,1e3*o._duration]}),"loaded"!==o._state&&(o._state="loaded",o._emit("load"),o._loadQueue()),o._autoplay&&o.play(),e._node.removeEventListener(n._canPlayEvent,e._loadFn,!1)}};var r={},a=function(e){var n=e._src;if(r[n])return e._duration=r[n].duration,void i(e);if(/^data:[^;]+;base64,/.test(n)){for(var o=atob(n.split(",")[1]),t=new Uint8Array(o.length),a=0;a<o.length;++a)t[a]=o.charCodeAt(a);d(t.buffer,e)}else{var _=new XMLHttpRequest;_.open("GET",n,!0),_.responseType="arraybuffer",_.onload=function(){var n=(_.status+"")[0];return"0"!==n&&"2"!==n&&"3"!==n?void e._emit("loaderror",null,"Failed loading audio file with status: "+_.status+"."):void d(_.response,e)},_.onerror=function(){e._webAudio&&(e._html5=!0,e._webAudio=!1,e._sounds=[],delete r[n],e.load())},u(_)}},u=function(e){try{e.send()}catch(n){e.onerror()}},d=function(e,o){n.ctx.decodeAudioData(e,function(e){e&&o._sounds.length>0&&(r[o._src]=e,i(o,e))},function(){o._emit("loaderror",null,"Decoding audio data failed.")})},i=function(e,n){n&&!e._duration&&(e._duration=n.duration),0===Object.keys(e._sprite).length&&(e._sprite={__default:[0,1e3*e._duration]}),"loaded"!==e._state&&(e._state="loaded",e._emit("load"),e._loadQueue()),e._autoplay&&e.play()},_=function(){n.noAudio=!1;try{"undefined"!=typeof AudioContext?n.ctx=new AudioContext:"undefined"!=typeof webkitAudioContext?n.ctx=new webkitAudioContext:n.usingWebAudio=!1}catch(e){n.usingWebAudio=!1}if(!n.usingWebAudio)if("undefined"!=typeof Audio)try{var e=new Audio;"undefined"==typeof e.oncanplaythrough&&(n._canPlayEvent="canplay")}catch(e){n.noAudio=!0}else n.noAudio=!0;try{var e=new Audio;e.muted&&(n.noAudio=!0)}catch(e){}var o=/iP(hone|od|ad)/.test(n._navigator&&n._navigator.platform),t=n._navigator&&n._navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/),r=t?parseInt(t[1],10):null;if(o&&r&&r<9){var a=/safari/.test(n._navigator&&n._navigator.userAgent.toLowerCase());(n._navigator&&n._navigator.standalone&&!a||n._navigator&&!n._navigator.standalone&&!a)&&(n.usingWebAudio=!1)}n.usingWebAudio&&(n.masterGain="undefined"==typeof n.ctx.createGain?n.ctx.createGainNode():n.ctx.createGain(),n.masterGain.gain.value=1,n.masterGain.connect(n.ctx.destination)),n._setup()};"function"==typeof define&&define.amd&&define([],function(){return{Howler:n,Howl:o}}),"undefined"!=typeof exports&&(exports.Howler=n,exports.Howl=o),"undefined"!=typeof window?(window.HowlerGlobal=e,window.Howler=n,window.Howl=o,window.Sound=t):"undefined"!=typeof global&&(global.HowlerGlobal=e,global.Howler=n,global.Howl=o,global.Sound=t)}();!function(e){function n(){}function t(e,n){return function(){e.apply(n,arguments)}}function o(e){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof e)throw new TypeError("not a function");this._state=0,this._handled=!1,this._value=void 0,this._deferreds=[],s(e,this)}function i(e,n){for(;3===e._state;)e=e._value;return 0===e._state?void e._deferreds.push(n):(e._handled=!0,void o._immediateFn(function(){var t=1===e._state?n.onFulfilled:n.onRejected;if(null===t)return void(1===e._state?r:u)(n.promise,e._value);var o;try{o=t(e._value)}catch(i){return void u(n.promise,i)}r(n.promise,o)}))}function r(e,n){try{if(n===e)throw new TypeError("A promise cannot be resolved with itself.");if(n&&("object"==typeof n||"function"==typeof n)){var i=n.then;if(n instanceof o)return e._state=3,e._value=n,void f(e);if("function"==typeof i)return void s(t(i,n),e)}e._state=1,e._value=n,f(e)}catch(r){u(e,r)}}function u(e,n){e._state=2,e._value=n,f(e)}function f(e){2===e._state&&0===e._deferreds.length&&o._immediateFn(function(){e._handled||o._unhandledRejectionFn(e._value)});for(var n=0,t=e._deferreds.length;n<t;n++)i(e,e._deferreds[n]);e._deferreds=null}function c(e,n,t){this.onFulfilled="function"==typeof e?e:null,this.onRejected="function"==typeof n?n:null,this.promise=t}function s(e,n){var t=!1;try{e(function(e){t||(t=!0,r(n,e))},function(e){t||(t=!0,u(n,e))})}catch(o){if(t)return;t=!0,u(n,o)}}var a=setTimeout;o.prototype["catch"]=function(e){return this.then(null,e)},o.prototype.then=function(e,t){var o=new this.constructor(n);return i(this,new c(e,t,o)),o},o.all=function(e){var n=Array.prototype.slice.call(e);return new o(function(e,t){function o(r,u){try{if(u&&("object"==typeof u||"function"==typeof u)){var f=u.then;if("function"==typeof f)return void f.call(u,function(e){o(r,e)},t)}n[r]=u,0===--i&&e(n)}catch(c){t(c)}}if(0===n.length)return e([]);for(var i=n.length,r=0;r<n.length;r++)o(r,n[r])})},o.resolve=function(e){return e&&"object"==typeof e&&e.constructor===o?e:new o(function(n){n(e)})},o.reject=function(e){return new o(function(n,t){t(e)})},o.race=function(e){return new o(function(n,t){for(var o=0,i=e.length;o<i;o++)e[o].then(n,t)})},o._immediateFn="function"==typeof setImmediate&&function(e){setImmediate(e)}||function(e){a(e,0)},o._unhandledRejectionFn=function(e){"undefined"!=typeof console&&console&&console.warn("Possible Unhandled Promise Rejection:",e)},o._setImmediateFn=function(e){o._immediateFn=e},o._setUnhandledRejectionFn=function(e){o._unhandledRejectionFn=e},"undefined"!=typeof module&&module.exports?module.exports=o:e.Promise||(e.Promise=o)}(this);var RRAIN=RRAIN||{};(function(ns){var App=function(){var canvas=this.canvas=$id("app");this.music=null;this.musicList;this.noteSpeed=0;this.wait=200;this.enableInput=true;this.enableSE=true;this.isPlaying=false;this.refs={musicDetail:$id("music-info"),repertoryList:$id("repertory"),musicNameDisplay:$id("music-name-display"),pauseBtn:$id("pause-btn"),filterNode:$id("load-filter"),gameField:$id("game-field")};this.noteSpeedDisplay=$id("note-speed-display");this.init()};App.prototype={init:function(){this.refs.gameField.style={width:SCREEN_WIDTH+"px",height:SCREEN_HEIGHT+"px"};resizeCover(this.refs.filterNode);window.addEventListener("resize",function(){resizeCover(this.refs.filterNode)});RRAIN.Loader.loadBatch({image:IMAGE_ASSETS,sound:SOUND_ASSETS,json:{musicList:MUSIC_LIST_PATH}}).then(function(){var musicList=this.musicList=RRAIN.Loader.getAsset("musicList").data.list;this._checkBrowserSupport();this.setupInputEvent();this.setupRepertoryList(musicList);console.log("init end")}.bind(this))},_checkBrowserSupport:function(){var ua=navigator.userAgent.toLowerCase();var unsupported=ua.indexOf("android")>0||ua.indexOf("MSIE")>0||ua.indexOf("trident")>0;if(unsupported){alert("ご使用のブラウザは推奨環境下ではありません。\nGoogle chrome, iOS safariでのプレイをオススメします");this.toggleSE(false)}},setupInputEvent:function(){var self=this;var onpointdown=function(e){if(!self.enableInput)return;e.preventDefault();if(this.isPlaying){if(self.game.pointstart)self.game.pointstart(e)}else{self.game.reset();self.isPlaying=true}};var onpointup=function(e){e.preventDefault();if(self.game.pointstart)self.game.pointstart(e)};this.canvas.addEventListener("mousedown",function(e){e.preventDefault();this.onpointdown()},false);this.canvas.addEventListener("touchstart",onpointdown,false);document.addEventListener("keydown",function(e){onpointdown()});this.canvas.addEventListener("mouseup",onpointup,false);this.canvas.addEventListener("touchend",onpointup,false);document.addEventListener("keyup",onpointup,false)},setupRepertoryList:function(musicList){var self=this;musicList.forEach(function(music,index){var li=document.createElement("li");li.textContent=music.name;li.style.background=DEFAULT_COLOR;li.style.opacity=DEFAULT_OPACITY;li.addEventListener("mousedown",_handleClick,false);li.addEventListener("touchstart",_handleClick,false);function _handleClick(e){if(self.music)self.music.stop();self.updateMusicDetail(music);var childs=self.refs.repertoryList.childNodes;Object.keys(childs).forEach(function(i){var cs=childs[i].style;cs.background=DEFAULT_COLOR;cs.opacity=.5});e.target.style.background=ACTIVE_COLOR;e.target.style.opacity=1;var selectedMusic=RRAIN.Loader.getAsset(music.name);if(!selectedMusic){self.toggleLoadingState(true);var p1=RRAIN.Loader.loadSound(DATA_PATH+music.src,music.name).then(function(res){self.music=res}).catch(function(error){alert("音源のロードに失敗しました");console.error(error);self.toggleLoadingState(false)});var p2=RRAIN.Loader.loadJson(DATA_PATH+music.fumen,"chart_"+music.name).then(function(res){}).catch(function(error){alert("譜面のロードに失敗しました");console.error(error);self.toggleLoadingState(false)});Promise.all([p1,p2]).then(postFunc)}else{self.music=selectedMusic;postFunc()}function postFunc(){self.toggleLoadingState(false);self.endhour=self.music.duration()+self.wait;self.music.play();self.refs.musicNameDisplay.innerHTML="♪ "+music.name}}self.refs.repertoryList.appendChild(li)})},updateMusicDetail:function(musicObj){this.refs.musicDetail.innerHTML=null;Object.keys(musicObj).forEach(function(key){if(key==="src"||key==="fumen"||key==="url")return;var val=musicObj[key];var li=document.createElement("li");if(key==="author"){var inner="<a href="+musicObj["url"]+">"+val+"</a>";li.innerHTML=key.toUpperCase()+": "+inner}else if(key==="difficulty"){li.innerHTML+=key.toUpperCase()+": ";for(var i=0;i<val;i++){li.innerHTML+="&#9733"}}else{li.textContent=key.toUpperCase()+": "+musicObj[key]}this.refs.musicDetail.appendChild(li)}.bind(this))},toggleSE:function(force){if(force){this.enableSE=force}else{this.enableSE=!this.enableSE}},toggleLoadingState:function(show){var visibility;if(show){visibility="visible";this.enableInput=false}else{visibility="hidden";this.enableInput=true}this.refs.filterNode.style.visibility=visibility},varyNoteSpeed:function(increment){var noteSpeed=this.noteSpeed;if(increment===true&&noteSpeed<NOTE_SPEED_RANGE.max){this.noteSpeed+=1}else if(!increment&&NOTE_SPEED_RANGE.min<noteSpeed){this.noteSpeed-=1}this.game.setNoteSpeed(this.noteSpeed);this.noteSpeedDisplay.innerHTML=this.noteSpeed}};ns.App=App;function $id(id){return document.getElementById(id)}function resizeCover(element){var target=element;var MaxHeight=Math.max(Math.max(document.body.clientHeight,document.body.scrollHeight),Math.max(document.documentElement.scrollHeight,document.documentElement.clientHeight));target.style.height=MaxHeight+"px";var MaxWidth=Math.max(Math.max(document.body.clientWidth,document.body.scrollWidth),Math.max(document.documentElement.scrollWidth,document.documentElement.clientWidth));target.style.width=MaxWidth+"px"}})(RRAIN);var RRAIN=RRAIN||{};(function(ns){var Loader={get LOADFUNC_MAP(){return{image:this.loadImage,json:this.loadJson,sound:this.loadSound}},_registered:{},getAsset:function(key){if(this._registered[key]!=null){return this._registered[key]}else{return false}},loadBatch:function(assets){var ps=new Array;var self=this;Object.keys(assets).forEach(function(type){Object.keys(assets[type]).forEach(function(key){var src=assets[type][key];var loadFunc=self.LOADFUNC_MAP[type].bind(self);ps.push(loadFunc(src,key))})});return Promise.all(ps)},loadSound:function(src,key){var self=this;if(typeof Howl==="undefined"){console.error("Howler.js is not load");return}return new Promise(function(resolve,reject){var sound=new Howl({src:[src],onload:function(e){self._registered[key]=sound;resolve(sound)},onloaderror:function(error){reject(error)}})})},loadImage:function(src,key){var self=this;return new Promise(function(resolve,reject){var img=new Image;img.onload=function(){self._registered[key]=img;resolve(img)};img.onerror=function(e){reject(e)};img.src=src})},loadJson:function(src,key){var self=this;return new Promise(function(resolve,reject){var xhr=new XMLHttpRequest;xhr.open("get",src,true);xhr.setRequestHeader("Pragma","no-cache");xhr.setRequestHeader("Cache-Control","no-cache");xhr.setRequestHeader("If-Modified-Since","Thu, 01 Jun 1970 00:00:00 GMT");xhr.onreadystatechange=function(){if(xhr.readyState===4&&xhr.status===200){var json={raw:xhr.responseText,data:JSON.parse(xhr.responseText)};resolve(json);self._registered[key]=json}};xhr.onerror=function(err){resolve(err)};xhr.send(null)})}};ns.Loader=Loader})(RRAIN);if(window.addEventListener){window.addEventListener("load",shareButtonReadSyncer,false)}else{window.attachEvent("onload",shareButtonReadSyncer)}function shareButtonReadSyncer(){setTimeout(function(){(function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(d.getElementById(id))return;js=d.createElement(s);js.id=id;js.src="//connect.facebook.net/ja_JP/sdk.js#xfbml=1&version=v2.0";fjs.parentNode.insertBefore(js,fjs)})(document,"script","facebook-jssdk");var scriptTag=document.createElement("script");scriptTag.type="text/javascript";scriptTag.src="https://apis.google.com/js/platform.js";scriptTag.async=true;document.getElementsByTagName("head")[0].appendChild(scriptTag);var scriptTag=document.createElement("script");
scriptTag.type="text/javascript";scriptTag.src="https://b.st-hatena.com/js/bookmark_button.js";scriptTag.async=true;document.getElementsByTagName("head")[0].appendChild(scriptTag);!function(d,i){if(!d.getElementById(i)){var j=d.createElement("script");j.id=i;j.src="https://widgets.getpocket.com/v1/j/btn.js?v=1";var w=d.getElementById(i);d.body.appendChild(j)}}(document,"pocket-btn-js")},1e3)}(function(ns){var Timer=function(){this._time=0;this.isStop=false;this._past=0};Timer.prototype.run=function(){this.isStop=false};Timer.prototype.update=function(){if(!this.isStop){if(!this._past){this._past=Date.now()}else{this._time+=Date.now()-this._past;this._past=Date.now()}}};Timer.prototype.toggle=function(){this.isStop=!this.isStop;this._past=0};Timer.prototype.pause=function(){this.isStop=true;this._past=0};Timer.prototype.setTime=function(time){this._time=time;this._past=0};Timer.prototype.reset=function(){this._time=0;this._past=0};Timer.prototype.time=function(){return this._time/1e3};ns.Timer=Timer})(window);var $id=function(id){return document.getElementById(id)};var createSpanArray=function(span,m,n,randomize){var array=[];for(var i=m;i<m+n;i++){array.push(span*i)}if(randomize===true){for(var i=0;i<array.length;i++){swap(array,i,Math.random()*(array.length-i)+i|0)}}return array;function swap(a,s,d){var t=a[s];a[s]=a[d];a[d]=t}};var resizeCover=function(element){var target=element;var MaxHeight=Math.max(Math.max(document.body.clientHeight,document.body.scrollHeight),Math.max(document.documentElement.scrollHeight,document.documentElement.clientHeight));target.style.height=MaxHeight+"px";var MaxWidth=Math.max(Math.max(document.body.clientWidth,document.body.scrollWidth),Math.max(document.documentElement.scrollWidth,document.documentElement.clientWidth));target.style.width=MaxWidth+"px"};var drawGradRect=function(context,x,y,width,height,color){context.save();var grad=context.createLinearGradient(x,y,x,y+height);if(color.length>0){for(var i=0,len=color.length;i<len;i++){grad.addColorStop(color[i][0],color[i][1])}}else{grad.addColorStop(0,"rgba(0, 0, 0, 0)");grad.addColorStop(1,color)}context.fillStyle=grad;context.fillRect(x,y,width,height);context.restore()};var DEBUG_MODE=false;var SCREEN_WIDTH=window.innerWidth>640?640:window.innerWidth*.9;var RATIO=SCREEN_WIDTH/640;var SCREEN_HEIGHT=Math.round(SCREEN_WIDTH/16*9);var NOTE_LIST=null;var FPS=60;var GRID_NUM=14;var NOTE_WIDTH=SCREEN_WIDTH/GRID_NUM*.8;var NOTE_HEIGHT=6*RATIO;var NOTE_POS_SPAN=Math.round(SCREEN_WIDTH/GRID_NUM);var NOTE_POSITIONS=createSpanArray(NOTE_POS_SPAN,4,8);var NOTE_POSITIONS_LEN=NOTE_POSITIONS.length;var NOTE_SPEED_RANGE={max:5,min:0};var NOTE_COLOR="rgb(139, 236, 242)";var LONG_NOTE_COLOR="rgb(77, 60, 212)";var WATER_COLOR="#125779";var EFFECT_COLOR=NOTE_COLOR;var THEME_COLOR={morning:"rgb(249, 250, 207)",daytime:"#B9F5EF",night:"rgb(0, 0, 0)"};var FILTER_COLOR="rgba(164, 146, 146, 0.59)";var DEFAULT_COLOR="rgb(60, 100, 214)";var ACTIVE_COLOR="rgb(161, 182, 241)";var DEFAULT_OPACITY=.5;var JUDGE_LINE_Y=SCREEN_HEIGHT*.7|0;var NOTE_DEST_Y=JUDGE_LINE_Y-NOTE_HEIGHT*.5;var EFFECT_HEIGHT=JUDGE_LINE_Y*.4;var RATING_TEXT_POS_X=SCREEN_WIDTH*.5;var RATING_TEXT_POS_Y=SCREEN_HEIGHT*.4;var SCORE_TEXT_FONT_SIZE=20*RATIO;var SCORE_TEXT_POS_X=SCREEN_WIDTH*.9;var SCORE_TEXT_POS_Y=SCORE_TEXT_FONT_SIZE*1.25;var PROGRESSBAR_X=10*RATIO;var PROGRESSBAR_Y=10*RATIO;var PROGRESSBAR_WIDTH=SCREEN_WIDTH*.6|0;var PROGRESSBAR_HEIGHT=8*RATIO;var LIGHT_POS_X=60*RATIO;var LIGHT_POS_Y=110*RATIO;var GIRL_POS_X=SCREEN_WIDTH*.75;var GIRL_POS_Y=75*RATIO;var RATING={out:.13,good:.1,nice:.05,great:.03};var SCORE={good:10,nice:50,great:100};var SOUND_ASSETS={clap:"./assets/sounds/clap.mp3",conga:"./assets/sounds/conga.mp3"};var IMAGE_ASSETS={streetLight:"./assets/images/streetLight2.png",girl:"./assets/images/girl.png"};var MUSIC_LIST_PATH="../data/music_list.json";var DATA_PATH="../data/";(function(window){new RRAIN.App;var music=null;var musicName=null;var app=$id("app");var bgCanvas=$id("bg");var holderElement=$id("game-field");var repertoryWrapper=$id("repertory-wrapper");var timer;var noteList=[];var hitEffect=null;var score=0;var chainNum=0;var maxChain=0;var fullChainNum=1;var rateText=null;var longNote=null;var btnFlg=false;var isPlaying=false;var autoPlay=false;var _ua=navigator.userAgent.toLowerCase();var enableSE=_ua.indexOf("android")>0||_ua.indexOf("MSIE")>0||_ua.indexOf("trident")>0?false:true;var enableInput=true;var isHTMLaudio=null;var canPlayMusic=true;var currentNoteIndex=1;var calib=Math.min(0,RATING.good);var zerohour=0;var endhour=0;var wait=3;var bpm=120;var noteSpeed=0;var activeMusicPointer=0;function appInitialize(){var musicList=RRAIN.Loader.getAsset("musicList").data.list;var updateMusicInfo=function(index){if(index==null)return;var parent=$id("music-info");parent.innerHTML=null;var obj=musicList[index];Object.keys(obj).forEach(function(key){if(key=="src"||key=="fumen"||key=="url"||key=="theme")return;var li=document.createElement("li");if(key=="author"){var inner="<a href="+obj["url"]+">"+obj[key]+"</a>";li.innerHTML=key.toUpperCase()+": "+inner}else if(key=="difficulty"){li.innerHTML+=key.toUpperCase()+": ";for(var i=0;i<obj[key];i++){li.innerHTML+="&#9733"}}else{li.textContent=key.toUpperCase()+": "+obj[key]}parent.appendChild(li)})};musicList.forEach(function(m,index){var li=document.createElement("li");li.textContent=m.name;li.style.background=index===activeMusicPointer?ACTIVE_COLOR:DEFAULT_COLOR;li.style.opacity=index===activeMusicPointer?1:DEFAULT_OPACITY;updateMusicInfo(activeMusicPointer);li.addEventListener("mousedown",_musicLoad,false);li.addEventListener("touchstart",_musicLoad,false);function _musicLoad(e){if(music)stopSound(music);var selected=RRAIN.Loader.getAsset(m.name);if(!selected){$id("load-filter").style.visibility="visible";enableInput=false;var p1=RRAIN.Loader.loadSound(DATA_PATH+m.src,m.name).then(function(res){music=res;endhour=music.duration()+wait});var p2=RRAIN.Loader.loadJson(DATA_PATH+m.fumen,"chart_"+m.name).then(function(res){setupFumen(res.raw)});Promise.all([p1,p2]).then(function(){gameReset();playSound(music);musicName=m.name;$id("music-name-display").innerHTML="♪ "+m.name;$id("load-filter").style.visibility="hidden";enableInput=true})}else{music=selected;endhour=music.duration()+wait;setupFumen(RRAIN.Loader.getAsset("chart_"+m.name).raw);gameReset();playSound(music);musicName=m.name;$id("music-name-display").innerHTML="♪ "+m.name;$id("load-filter").style.visibility="hidden";enableInput=true}var childs=$id("repertory").childNodes;Object.keys(childs).forEach(function(i){var c=childs[i];c.style.background=DEFAULT_COLOR;c.style.opacity=.5});activeMusicPointer=index;updateMusicInfo(index);e.target.style.background=ACTIVE_COLOR;e.target.style.opacity=1}$id("repertory").appendChild(li)});init();var _func=function(event){return function f(event){$id("load-filter").style.visibility="visible";enableInput=false;window.removeEventListener(event.type,_func,false);app.removeEventListener(event.type,_func,false);var addInputEvents=function(){app.addEventListener("mousedown",function(e){e.preventDefault();onpointdown()},false);app.addEventListener("touchstart",function(e){e.preventDefault();onpointdown()},false);document.addEventListener("keydown",function(e){e.preventDefault();onpointdown()});app.addEventListener("mouseup",onpointup,false);app.addEventListener("touchend",onpointup,false);document.addEventListener("keyup",onpointup,false)};var checkAudioType=function(audio){var _audiotype=audio.constructor.toString().toLowerCase();isHTMLaudio=_audiotype.match(/htmlaudio/)};if(!music){if(!musicList){return console.log("レパートリー情報がありません")}var musicData=musicList[activeMusicPointer];var p1=RRAIN.Loader.loadSound(DATA_PATH+musicData.src,musicData.name).then(function(audio){music=audio;endhour=music.duration()+wait;checkAudioType(music)});var p2=RRAIN.Loader.loadJson(DATA_PATH+musicData.fumen,"chart_"+musicData.name).then(function(res){setupFumen(res.raw)});Promise.all([p1,p2]).then(function(){addInputEvents();gameReset();isPlaying=true;$id("music-name-display").innerHTML="♪ "+musicData.name;$id("load-filter").style.visibility="hidden";enableInput=true})}else{checkAudioType(music);stopSound(music);addInputEvents();gameReset();isPlaying=true;$id("load-filter").style.visibility="hidden";enableInput=true}}}();window.addEventListener("keyup",_func,false);app.addEventListener("touchend",_func,false)}function setupFumen(data){importData(data);noteList=NOTE_LIST.slice();fullChainNum=0;noteList.forEach(function(note){if(note.length){fullChainNum+=2}else{fullChainNum++}})}function gameReset(){currentNoteIndex=0;music.stop();if(autoPlay)btnFlg=true;rateText=null;chainNum=0;maxChain=0;score=0;hitEffect=0;timer.reset();timer.run();canPlayMusic=true;console.log("reset",music)}function init(){timer=new Timer;app.width=bgCanvas.width=SCREEN_WIDTH;app.height=bgCanvas.height=SCREEN_HEIGHT;holderElement.style.width=SCREEN_WIDTH+"px";holderElement.style.height=SCREEN_HEIGHT+"px";resizeCover($id("load-filter"));window.addEventListener("resize",function(){console.log("resized");resizeCover($id("load-filter"))});var bgctx=bgCanvas.getContext("2d");bgctx.fillStyle="rgb(0, 0, 0)";bgctx.fillRect(0,0,SCREEN_WIDTH,SCREEN_HEIGHT);bgctx.drawImage(RRAIN.Loader.getAsset("girl"),GIRL_POS_X,GIRL_POS_Y,124*1.1*RATIO,166*1.1*RATIO);drawGradRect(bgctx,0,JUDGE_LINE_Y,SCREEN_WIDTH,SCREEN_HEIGHT-JUDGE_LINE_Y,[[0,WATER_COLOR],[1,"rgba(255, 255, 255, 0)"]]);bgctx.drawImage(RRAIN.Loader.getAsset("streetLight"),0,0,118,308,LIGHT_POS_X,LIGHT_POS_Y,132*RATIO,358*RATIO);bgctx.fillStyle=FILTER_COLOR;bgctx.fillRect(0,0,SCREEN_WIDTH,SCREEN_HEIGHT);$id("note-speed-display").innerHTML=noteSpeed;var debugElm=$id("debug");if(!DEBUG_MODE)debugElm.parentNode.removeChild(debugElm);main()}function main(){if(isPlaying){timer.update();calc();if(DEBUG_MODE)$id("time").innerHTML=timer.time()}screenRender();setTimeout(main,1e3/FPS)}function calc(){var i,len;var noteTime;var time=timer.time();if(time>wait-zerohour&&canPlayMusic){console.log("music start");canPlayMusic=false;playSound(music)}if(time>endhour&&!music.paused){console.log("music end")}if(time>endhour){isPlaying=false}for(i=currentNoteIndex,len=noteList.length;i<len;i++){noteTime=noteList[i];if(noteTime.length){noteTime=noteTime[0]}if(time>noteTime+wait+RATING.good&&!longNote){miss();currentNoteIndex++}if(autoPlay&&!longNote){if(time>noteTime+wait-RATING.great*.5){judge()}}}if(longNote!=null){var rTime=longNote-time+calib;if(btnFlg){if(rTime>0){hitEffect=3}else{longNote=null;effect("great")}}else{longNote=null;effect("miss")}}}function screenRender(){var ctx=app.getContext("2d");var relativeTime=0;var corr=bpm*1.75*RATIO*(1+noteSpeed*.5);var deltaY;var drawingPointX=100;var drawingPointY;var noteHeight=0;var effectPosX=null;var i,len;var noteTime=null;ctx.clearRect(0,0,app.width,app.height);ctx.save();for(i=currentNoteIndex,len=noteList.length;i<len;i++){noteHeight=NOTE_HEIGHT;drawingPointX=NOTE_POSITIONS[i%NOTE_POSITIONS_LEN];noteTime=noteList[i];if(noteTime.length){ctx.fillStyle=LONG_NOTE_COLOR;noteHeight=-(noteTime[1]-noteTime[0])*corr;noteTime=noteTime[0]}else{ctx.fillStyle=NOTE_COLOR}noteTime+=wait;relativeTime=noteTime-timer.time();deltaY=relativeTime*corr;drawingPointY=NOTE_DEST_Y-deltaY;if(drawingPointY<-10)continue;if(relativeTime<0){noteHeight-=relativeTime*corr;drawingPointY=NOTE_DEST_Y}ctx.fillRect(drawingPointX,drawingPointY,NOTE_WIDTH,noteHeight)}ctx.restore();ctx.fillStyle="white";ctx.font=SCORE_TEXT_FONT_SIZE+"px 'Audiowide'";ctx.textAlign="center";effectPosX=longNote?NOTE_POSITIONS[currentNoteIndex%NOTE_POSITIONS_LEN]:NOTE_POSITIONS[(currentNoteIndex-1)%NOTE_POSITIONS_LEN];if(isPlaying){if(rateText){ctx.save();ctx.fillStyle=rateText.match(/great|nice/i)==null?"rgba(120, 158, 215, 0.68)":"rgb(177, 224, 125)";ctx.fillText(rateText,effectPosX+NOTE_WIDTH/2,JUDGE_LINE_Y*.8);if(!isPlaying)rateText=null;ctx.restore()}if(chainNum!==0){ctx.fillText(chainNum+" CHAIN",RATING_TEXT_POS_X,RATING_TEXT_POS_Y+16)}ctx.textAlign="right";ctx.fillText(score,SCORE_TEXT_POS_X,SCORE_TEXT_POS_Y);if(hitEffect>0){ctx.save();ctx.globalAlpha=hitEffect*.1;drawGradRect(ctx,effectPosX,JUDGE_LINE_Y-EFFECT_HEIGHT,NOTE_WIDTH,EFFECT_HEIGHT,[[0,"rgba(0, 0, 0, 0)"],[1,EFFECT_COLOR]]);hitEffect--;ctx.restore()}ctx.save();var remainRatio=timer.time()/endhour;ctx.fillStyle="#d5e9f1";ctx.fillRect(PROGRESSBAR_X,PROGRESSBAR_Y,PROGRESSBAR_WIDTH,PROGRESSBAR_HEIGHT);ctx.fillStyle="#5099b6";ctx.fillRect(PROGRESSBAR_X,PROGRESSBAR_Y,PROGRESSBAR_WIDTH*remainRatio,PROGRESSBAR_HEIGHT);ctx.restore();repertoryWrapper.style.visibility="hidden";$id("pauseBtn").style.visibility="visible"}if(!isPlaying){ctx.save();ctx.fillStyle="rgba(0, 0, 0, 0.7)";ctx.fillRect(0,0,SCREEN_WIDTH,SCREEN_HEIGHT);ctx.textAlign="center";ctx.fillStyle="rgba(255, 255, 255, 0.99)";ctx.globalAlpha=.4;ctx.fillText("TAP KEYBOARD or SCREEN to PLAY",RATING_TEXT_POS_X,SCORE_TEXT_FONT_SIZE*2);ctx.globalAlpha=1;if(score){ctx.fillText("RESULT",RATING_TEXT_POS_X,RATING_TEXT_POS_Y)}if(score){ctx.fillText("SCORE: "+score+"",RATING_TEXT_POS_X,RATING_TEXT_POS_Y+SCORE_TEXT_FONT_SIZE*1.5)}if(maxChain){ctx.fillText("MAX-CHAIN: "+maxChain+" / "+fullChainNum,RATING_TEXT_POS_X,RATING_TEXT_POS_Y+SCORE_TEXT_FONT_SIZE*3)}ctx.restore();repertoryWrapper.style.visibility="visible";$id("pauseBtn").style.visibility="hidden"}}function judge(){var noteTime=noteList[currentNoteIndex];var _longEnd=null;if(typeof noteTime=="object"){_longEnd=noteTime[1];noteTime=noteTime[0];_longEnd+=wait}noteTime+=wait;var rTime=noteTime-timer.time()+calib;if(rTime<0)rTime*=-1;if(rTime>RATING.out)return;longNote=_longEnd;if(rTime<RATING.great)return effect("great");if(rTime<RATING.nice)return effect("nice");if(rTime<RATING.good)return effect("good");longNote=null;if(rTime<RATING.out)return effect("miss")}function effect(rating){if(longNote==null)currentNoteIndex++;switch(rating){case"great":chainNum++;rateText="GREAT!!!";playShot("clap");hitEffect=16;score+=SCORE.great;break;case"nice":chainNum++;rateText="NICE!";hitEffect=10;playShot("clap");score+=SCORE.nice;break;case"good":chainNum++;rateText="GOOD";playShot("conga");score+=SCORE.good;break;case"hold":break;case"miss":miss();break;default:break}if(maxChain==0||maxChain<=chainNum){maxChain=chainNum}}function miss(){chainNum=0;rateText="MISS..."}function playShot(key){if(!enableSE)return;if(isHTMLaudio){var audio=RRAIN.Loader.getAsset(key);audio.paused=true;audio.position=0;audio.play()}else{RRAIN.Loader.getAsset(key).play()}}function playSound(audio){audio.play()}function stopSound(audio){audio.stop()}function onpointdown(e){if(!enableInput)return;if(!isPlaying){gameReset();isPlaying=true;return}if(isPlaying){if(autoPlay)return;if(btnFlg)return;btnFlg=true;judge()}else{isPlaying=true}}function onpointup(e){e.preventDefault();if(!enableInput)return;if(autoPlay)return;btnFlg=false}function varyNoteSpeed(dir,element){var dir=dir!=null?dir:null;if(dir==="up"&&noteSpeed<NOTE_SPEED_RANGE.max){noteSpeed+=1}else if(dir==="down"&&NOTE_SPEED_RANGE.min<noteSpeed){noteSpeed-=1}element.innerHTML=noteSpeed}function importData(jsonData){var dataobj;try{dataobj=JSON.parse(jsonData)}catch(e){alert("譜面データをパース出来ませんでした");console.log(e)}bpm=dataobj.BPM;NOTE_LIST=dataobj.noteList;zerohour=dataobj.zerohour;if(dataobj.endhour)endhour=dataobj.endhour+wait}function pause(){stopSound(music);timer.pause();isPlaying=false}function setAutoPlay(){autoPlay=!autoPlay?true:false;console.log("autoplay: ",autoPlay)}$id("note-speed-up-button").onclick=function(){varyNoteSpeed("up",$id("note-speed-display"))};$id("note-speed-down-button").onclick=function(){varyNoteSpeed("down",$id("note-speed-display"))};$id("autoPlayBtn").addEventListener("click",setAutoPlay,false);$id("resetBtn").addEventListener("click",gameReset,false);$id("pauseBtn").addEventListener("click",pause)})(window);
